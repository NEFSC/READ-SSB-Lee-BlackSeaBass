---
title: 'Economic Informed Stock Assessments: Using Prices to Understand the Length of Fish'
authors:
  - name: Min-Yang Lee
    email: Min-Yang.Lee@noaa.gov
    address: [NOAA Northeast Fisheries Science Center, 166 Water Street, Woods Hole, MA 02543, USA]
    corresponding_author: yes
  - name: Emily Liljestrand
    address: [NOAA Northeast Fisheries Science Center, 166 Water Street, Woods Hole, MA 02543, USA]
date: "`r format(Sys.time(), '%B %d, %Y')`" 
abstract: |
 The length- and age-structure of commercial landings is a crucial input to fish stock assessment. In the Northeast United States, NOAA Fisheries deploys samplers to fish dealers to measure the length of commercially landed fish.  When there are few or no samples of a market category of fish, the informational content of fish prices can be used to make an inference about the size of an unsampled market category. We use the Black Sea Bass fishery in the Northeast United States to illustrate our approach to using economic data to inform stock assessments.  There are 5 common market categories: Jumbo, Large, Medium, Small, and Unclassified.  From 2020 to 2023, 5 to 10% of commercial landings were in the “Unclassified” market category; but no fish in this category were measured. A preliminary hedonic model confirms that prices vary by market category: “Unclassified” Black Sea Bass are priced between “Large” and “Medium” fish. We fit a categorical Random Forest to predict the probability that a transaction belongs to a particular market category using prices and other variables.  We use the results to predict the probability of the “Unclassified” belonging to any of the other market categories, allowing us to construct a price-informed length structure of commercial landings. 
keywords: 
  - Hedonic Prices
  - Age structure
  -  Stock assessment
bibliography: "C:/Users/min-yang.lee/Documents/library.bib"
link-citations: yes
header-includes:
- \usepackage{graphicx}

- \usepackage{float}
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
output: 
  bookdown::pdf_book:
    base_format: rticles::oup_article
    keep_tex: yes
    toc: False
    fig_caption: yes
    pandoc_args: [ "--csl", "ices-journal-of-marine-science.csl" ]


---


 <!---- 
 The hardcoded bibilography is ghastly. 
Summary and Housekeeping

I did my data processing with  ``\stata_code\data_extraction_processing\extraction\commercial\00_cams_extraction.do`` and ``00_extraction_wrapper.do``

I also ran many of the  files in ``\stata_code\data_extraction_processing\analysis`` to do some exploratory analysis. 

Warnings: There is something funky going on with VA "status=PZERO" starting in 2021.  There is also something funky going on with Delaware landings, but there are no hullids/permit numbers so I don't think this will throw anything off at the vessel level.

--->

```{r global_options, include=FALSE}

library("foreign")
library("here")
library("tidyverse")
library("scales")
library("knitr")
library("lubridate")
library("kableExtra")
library("haven")
library("mapview")
library("sf")
library("htmltools")
here::i_am("writing/Economic_informed_stock_assessments.Rmd")
# pak::pak("adletaw/captioner")
library("captioner")
fig_nums <- captioner(prefix= "Figure")

#############################################################################
#knitr options
knitr::opts_chunk$set(echo = TRUE)

#knitr::opts_chunk$set(echo=FALSE, warning = FALSE, error = FALSE, message = FALSE, comment = FALSE, cache = FALSE, progress = TRUE, verbose = FALSE, 
#											dpi = 600)
options(tinytex.verbose = TRUE)
# options(knitr.table.format = "latex")
options(scipen=999)


#############################################################################
my_images<-here("images")

descriptive_images<-here("images","descriptive")
exploratory_images<-here("images","exploratory")


# Read in statistical areas
stat_areas_location<-here("data_folder","external","shapefiles","Statistical_Areas_2010.shp")
stat_areas <- st_read(dsn = stat_areas_location)

#trim out some stat areas that I don't care about.
stat_areas<-stat_areas %>%
  dplyr::filter(Id>=460) %>% # Canada
   dplyr::filter(Id<=711) %>% # SERO
  dplyr::filter(!Id %in% c(640,650,660,670,680) ) #Offshore


options(scipen=0)

lbs_per_mt<-2204.62

imagefolder<-here("images")

pred_vintage<-"2025-05-24"

nocluster_testing_predictions<-readRDS(here("results","ranger",paste0("aggregate_test_predictions_nocluster",pred_vintage, ".Rds")))
nocluster_full_predictions<-readRDS(here("results","ranger",paste0("aggregate_full_predictions_nocluster",pred_vintage, ".Rds")))
aggregate_oos_predictions<-readRDS(here("results","ranger",paste0("aggregate_oos_predictions_nocluster",pred_vintage, ".Rds")))



```

# Introduction

<!--- Include the next 2 child documents.   --->
```{r, child=here("writing", c("summary.Rmd")),  eval=FALSE}
```

The age-structure of commercial landings is a crucial input to the quantitative 
stock assessments in the Northeast United States. In the Northeast US, commercial
fishing vessels catch fish and sell their landed fish to fish dealers, who sort
the catch into market categories.   The National Marine Fisheries Service
deploys biological samplers to measure the length of commercially landed fish. 
Otoliths are collected from a subset of measured fish; this information is used
to convert the landed weight of all market categories into numbers-at-age
of commercial landings. The stock assessment enterprise in the Northeast U.S. has a series of business 
rules for handling gaps in the market category to age relationship that arise 
when certain market categories are either not sampled or under sampled. This 
typically involves borrowing from neighboring strata.

In this article, we propose an approach that uses the price of fish 
to fill this data gap. We apply this approach to the stock assessment for Black Sea Bass (*Centropristis striata*) in the Northeast United States. Dealers purchase black sea bass from fishing vessels and sort them into in market categories. From 2020 to 2023, 5 to 10% of
commercial landings were in the “Unclassified” market category; however no fish in this category were measured. 

The general approach is as follows (terrible writing).  As part of our exploratory data analysis, we estimate a simple hedonic model to confirm that prices vary by market category. We tune, train, and validate a random forest model to classify fish into one of the four primary market categories. Finally, we conduct out-of-sample prediction on Unclassified fish.

Our ultimate goal is to improve the stock assessment enterprise by including more 
information about the true size of un-measured "Unclassified" fish. This requires 
predictions of the Unclassified fish to be aggregated to the year-stock unit level and the accuracy of
an individual prediction is of no interest. This method is good because it can be applied to existing streams of historical data.
It can be used to reconfigure sampling coverage.

# Background

<!--- Include the next 2 child documents.   --->
```{r, child=here("writing", c("BSB_history.Rmd", "BSB_economic_background.Rmd")),  eval=FALSE}
```

## Catching, Classifying, and Selling  Fish

Black sea bass are caught by fishing vessels that typically use bottom trawl and
pot/trap gear; gillnets and hook-and-line are less commonly used. Firms can target both
sizes of fish and their catch of other species, but cannot perfectly control 
what they catch and land.  The ability to target, and therefore the landings composition
is impacted by fishing regulations, which vary by state. For example, the seasonal inshore movement during 
the spring and offshore movement  during the fall [@Moser2009] can affect the composition of landings.  When fish are offshore, they are
less available to smaller vessels or those that are registered in states that 
manage with stringent possession limits.  Strong year classes can make a size 
class more available during certain years.   



```{r length-histograms,echo=FALSE,out.width="48%", fig.show='hold', fig.align='center',fig.cap="Length and Price Frequencies by market categories."}
knitr::include_graphics(c(here("images","background","length_frequencies_by_market_categories.png"),here("images","exploratory","wprice_histograms_vertical.png")))
```


After landing, fish are delivered to buyers (fish dealer), where they classified into market categories by the dealer.  There are four prevalent market categories (Jumbo, Large, Medium/Market, and Small), plus an "Unclassified" category^[There is a "Mixed or Unsized" market category (combined with the "Unclassified" market category). The Extra Small and PeeWee are combined with the Small category.].  Figure \@ref(fig:length-histograms) illustrates that fish in the "Unclassified" or "Mixed" category are precisely that, an unobserved combination of the other market categories. The definitions of the size classes may vary over time (year-to-year, month-to-month) or space (state-to-state or stock area to stock area).  Fish dealers may act as middlemen, simply selling fish to processors, restaurants, or final consumers.  They may do some processing themselves and sell filleted fish to entities farther along the value chain.

Prices of fish depend on the size of fish; the fact consumers typically prefer larger fish motivates the stock assessment enterprise to collect size information by disaggregated by market category.  Prices are also influenced by other attributes, including freshness, fat content, water content,buyer- and seller- effects, and the quantity attributes supplied to the market^[@McConnell2000, @Carroll2001, @Kristofersson2004, @Kristofersson2007,  @Hammarlund2015,  @Gobillon2017, and @Ardini2018 are just a few examples.]. 

Prices can be used to predict market category only if prices actually vary by market category. Figure  \@ref(fig:length-histograms) suggests that is the case and a simple hedonic model verifies that prices do indeed vary by market category (Table \ref{HedonicTableA}) .  The price of Jumbo Black Sea Bass is approximately \$6 per pound, while the price of medium Black Sea Bass is closer to \$3.50.  Interestingly, the Unclassified market category has an average price of \$4.40 per pound, in between that of Large and Medium fish, suggesting that Unclassified fish may be a mix of these other two categories^[A hedonic price model is not the main focus of this research, nevertheless, we report more details about the simple model in the Appendix.].

## Regulatory Environment

The fishery is jointly managed by the ASFMC and the MAFMC.  Regulations are enacted 
by GARFO.  There is also a South Atlantic stock that is managed by SAFMC.

From 1996 through 2003, the fishery was managed primarily by quarterly catch 
limits for the entire fishery. There were early closures in 1999 (Quarters 2,3,4),
2000 (2,3,4), and 2001 (all). Quota was allocated to each state staring in 2003
(Amendment 13) and is monitored based on landed state. In 2021, the formula 
that allocates commercial quotas to the states was revised; 75% of the quota is
allocated according to historical  fishing and 25% is allocated in proportion 
to where the biomass is located.

There is some catch that occurs within state waters by fishing vessels that do not 
have federal permits. Three states  (MD, DE, and VA) 
have IFQ programs that started in 2004. Current minimum size limits are 11" 
or 12".  Possession limits vary widely by state; the IFQ states do not have 
possession limits while Massachusetts and Rhode Island use seasonally varying 
limits that have been as strict as 50 lbs/day or as loose as 1,500 lbs per week.
Nearly all states require a vessel operator to have a limited access permit to 
land black sea bass in that state.



## Black Sea Bass and the Stock Assessment Enterprise 

### Stock assessment 

We don't need a full blown description of the stock assessment, but we want to use 
this section pull out the life history and stock assessment features that 
to justify the predictors we are using in the model.


* life history background
* stock assessment background
  * Spatially structured assessment model (North and South). Stock is partitioned into Northern and Southern subregions.
Migration between subareas. The stocks are different and have different
underlying size compositions. For example, there appears to be a sizable 2012, 2018, 
year class in the North stock

The Mid-Atlantic black sea bass is assessed using a spatially explicit model;
there is a Northern and Southern stock.  The time step is divided into half years. 
Ideally input data, like the numbers-at-age of commercial landings, is also constructed
using North-South data in half years. 

* Semester

Is there Size clustering in the ocean? Either in time or in space?
  Do big fish hang out in one spot at one time?
  Do smaller fish hang on in a different spot?

* Recent landings in the stock area by market category: catching fish is patchy.
If vessels are catching alot of larges, they are going to keep catching lots of 
larges.

* Recent landings in the state by market category: Same. In addition, there's 
    persistent "demand" if vessels can move around. processors and customers
    are set up for certain things.
* today's landings from a stock area by market category by other boats: same as above
* today's landings from a in a state by market category by other boats
* state and stock area trips
* lndlb (trip level landings by market category)
* trip level landings of black sea bass -- trips with large quantities might
    be more likely to sort. 

### Port Sampling for Ages and Lengths 

Analysts request coverage levels of different market categories. These request are
not always met.

```{r BorrowedLengths,echo=FALSE,out.width="48%", fig.align='center',fig.cap="Borrowed Lengths in Black Sea Bass. Slide 8 from the 2023 BSB commerical data overview"}
knitr::include_graphics(here("images","background",c("2023_BSB_UNIT_TOR2_commercialdata_slide8.jpg")))
```

Figure \@ref(fig:BorrowedLengths) illustrates the problem generally.  Pink in the bar graphs are good, this means there were enough measured fish in a market category.  Everything else indicates a certain amount of "borrowing" of data, where lengths are taken from market-area-semester combination.  



# Methods and Data

The goal of this research is to accurately predict the true market category of the unclassified fish
aggregated at the year-, semester-, and subregion. Neither the accuracy of a particular prediction nor the causal mechanisms by which one variable affects another is not of interest.  Machine learning approaches, which focus on accurate prediction of an outcome variable instead of the causal relationship between predictors and outcome, are attractive methods [@@Varian2014; @Mullainathan2017; @Athey2019].  These approaches have recently exploded in use in fisheries, ecology, and economics [@Rubbens2023; @Kuhn2024; @Akselrud2024]. Applications include from classifying fishing activity with Vessel Monitoring Systems or Autotmatic Identification Systems [@Russo2011], building predictive models of fishing vessel trip costs [@Chan2021] and prices [@francca2024price], and image processing [@Alvarez-Ellacuria2020].

In this application, we use a random forest model [@Breiman2001]; applications of these models in fisheries include classification of acoustic data [@Fallon2016, @Proud2020], fishery metiers [@Oostdijk2024], and habitat [@Liu2025].  We tune and train our model on 90\% of our data, we reserve 10% of our data to validate model fit. Random Forests are can viewed as ensembles of Classification and Regression Trees [CART, @Breiman1984].   A classification tree repeatedly partitions observations into two groups based on a single explanatory variable.  The optimal explanatory variable to use and value at which the split occurs is selected by minimizing a measure of variation among member of the partition; we use gini impurity.  Intuitively, the best split produces groups with homogenous outcomes.   The CART algorithm continues splitting until a user specified stopping-criteria is met.

Single classification trees are prone to poor out of sample performance; intuitively, this occurs when the model is overfit to the training dataset.  Random forests improve out of sample prediction by bootstrapping and restricting each bootstrap replication to a small number of randomly selected predictors [@Breiman2001].  Both modifications induce variation in the individual classification trees and leads to better out-of-sample performance.  The number of predictors to include in the model is the *mtry* hyperparameter and the optimal value is determined during the model tuning process. 

We tune the random forest model by further dividing our training data into 10 approximately equal folds.  We use 10-fold cross validation to select the optimal *mtry* parameter for the random forest, selecting the value that minimizes the Brier classification score [@Kruppa2014].  After finding the optimal value of *mtry*, we train the model on the 90% training sample and validate on the remaining 10\%. This provides some assurance that the model has good  out-of-sample prediction.  The random forest model is fit in R using the ``ranger`` package; we use  ``tidymodels`` packages to facilitate tuning, training, and out-of-sample predicting.  

Economic theory and on-the-ground expertise of the subject matter (the black sea bass stock assessment and commercial fishery) guide variable selection [@Mullainathan2017]. We refer the interested reader to @Strobl2009, @Varian2014, @Mullainathan2017, and @Hastie2023 for further reading.

The buyers (dealers) are the entities that classify the fish and dealers are likely to have an unobserved propensity to 
grade fish into particular classes. This unobserved heterogeneity poses two challenges.  

First, including a full set of binary indicator variables to account dealer-specific 
effects ("one-hot" encoding) can lead to both overfitting
[@Breiman2001; @Hastie2023] and bias [c.f @Strobl2007; @Strobl2009]. 
Instead we use a variation of target encoding.  Application of a standard
target-encoding system would involve computing dealer-specific class probabilities
over the 2015-2025 and including those probabilities as factors. This feels 
somewhat troubling to an economist concerned about simultaneity, a concern which
may be misplaced. Nevertheless, we compute dealer-specific class probabilities
over the 2010-2014 time period and enter these as predictors instead. Dealers 
that did not buy or sell black sea bass during this time have missing values.

Second, @Roberts2017 note that standard cross-validation techniques can be overly optimistic
when observations are dependent but are implicitly treated as independent during a random cross-validation.   This occurs because 
the hold out data used for cross-validation is not actually independent. @Roberts2017 suggest
that the practical implications of this depend on the purposes of the model; if prediction on 
"similar" data is the goal, then a standard cross-validation may be appropriate.
We try two methods of cross validation in our training.  The first is the standard random cross-validation; observations are assigned randomly into folds.  In the second method, we group by "dealer identifier" so that all of a dealer's observations are contained
in either the training dataset or the validation dataset.  This ensures that the
validation fold does not inadvertently contain "training data", which would lead
to overly optimistic model fit.  Keeping the entirety of dealer's
observations in either the training or validation datasets reduces the likelihood
of information leakage^[Information leakage occurs when a model essentially 
memorizes the input data, leading to validation metrics that are overly-optimistic.  
This can cause poor out of sample predictions.]

After fitting the data, we predict out of sample on the Unclassified Landings.  We do this "probabilistically", 
using the trained model to predict the probability of class memembership and then aggregating the 
landed pounds to the year-, market category-, and subregion level. 

## A Simple Theoretical Model Provides Guidance About Explanatory Factors

The core concept of this research is simple: use the information contained in transaction level prices to infer something about the size of the Unclassified fish.  A simple theoretical model sketch can provide guidance about explanatory factors that belong in the model. We assume a perfectly competitive market for *ex-vessel* fish: there are many dealers and vessels, no vertical integration,  no transactions costs associated with selling, all dealers and vessels know the prices being paid and the quantities begin supplied, and individuals are small relative to the market and cannot influence market prices. <!--- We also assume there is no vertical integration between dealers and vessels: a dealer and a fishing vessel is not owned by the same firm and there is no "forward" contracting in which buyers and sellers agree in advance on a price. --->

We assume that dealers have a perfectly elastic demand curve for the two categories of fish, Jumbo and Large, and that they prefer Jumbo relative to large.  A perfectly elastic demand curve means that dealers will buy all Jumbo landings as long as the price of Jumbo is less than or equal to $p_J$. The same holds true for the Large market category. Since dealers prefer Jumbo to Large,  the price of Jumbo is strictly greater than the price of Large: $p_J > p_L$.  

If we observe an Unclassified transaction where $p=p_J$, we can infer that actually a sale of Jumbo; if we observe an Unclassified transaction where $p=p_L$, we can infer that it is a sale of Large. Finally, if we observe a price in between the Large and Jumbo price:

\begin{equation}
\label{unknown1}
p= \alpha p_J+ (1-\alpha) p_L \hspace{2mm} \forall \hspace{2mm} \alpha \in (0,1)
\end{equation},

we can infer that the transaction is a mix of $\alpha$ Jumbo and $(1-\alpha)$ Large.  The last fact suggests that a method that predicts the probability of class membership for a transaction, as opposed to assigning a transaction to a class is preferred. 

### Downward Sloping Demand

A perfectly inelastic demand curve is unrealistic.  The demand curve for nearly fish is downward sloping: increases in quantity supplied of a category of fish will will reduce the price of that category [@Lee2014Hedonic; @Ardini2018, and Table \ref{HedonicTableA}]. The different market categories are substitutes: increases in the quantity supplied of Large will reduce the price of Jumbo and vise-versa. Finally, there are other factors that impact prices, these are collected into $Z$.    

Therefore:
\begin{equation}
\label{demand}
$p_J = f_J(q_J,q_L; Z)$,
\end{equation}
where $f_J()$ is decreasing in both quantities and $f_L()$ is defined analogously.  Downward sloping demand implies that equation \ref{unknown1} should be modified by substituting in \ref{demand}.

### More that two market categories

When there are more than two market categories (say, Medium), equation \ref{unknown1} becomes:

\begin{align}
p&= \beta_1 p_J+ \beta_2 p_L + (1-\beta_1-\beta_2) \\\label{unknown2}
\sum_{i=1}^3 \beta_i&=1\\
\geq 0 &\beta_i \geq 1 \hspace{2mm} \forall i=1,2
\end{align}
Intuitively, observing a transaction price that falls between two market categories does not imply that a transaction is a linear combination of the two adjacent categories. This suggests that including other proxies for beyond just prices and factors that affect prices is necessary.

### The Competitive Market Equilibrium and the Law of One Price

The assumption of a competitive market is critical to our ability to use prices to infer market category. In brief, assume that a dealer did not offer the prevailing Jumbo price to a fishing vessel, instead offering a lower price. A competitive market ensures that this dealer would not purchase any Jumbo fish at this price; vessels with Jumbo fish to sell would simply sell to another dealer and if the dealer wanted to purchase Jumbos, it would have to raise it's offer price.  All identical goods will sell at identical prices; observations of identical goods with different prices suggest that some conditions of a competitive market are absent [@Lamont2003].  Variations of the law of one price that account for heterogenous goods, informational assymmetries [@Salop1982].  Different data availability have been proposed and tested statistically [@Asche2002; @Nielsen2009; @Pettersen2018]. 


In this application, transactions by the same vessel, market category, and day are transactions of identical goods.  The hedonic model (Table \ref{HedonicTableA}) suggests factors like gear and month also impact prices. Transactions on different days are different in two dimensions: there may be seasonal variation in meat quality and daily variation in quantity supplied. There may be regional variation in prices if is systematic variation in transportation costs from dealer to final consumer or differences in  costs of processing whole fish into final form  [@samuelson1954transfer; @Krugman1991a].




## Data


<!---  
  A second, less-conventional validation might be available.  We have some years (2018-2020) where we sample lengths for the unclassified fish.  This can be used to construct a true catch-at-length distribution (outside the ML model). Inside the ML model, we predict the class of the "unclassified" into the constituent market categories and apply the length keys to those to form a catch-at-length distribution.  Construct some sort of loss function based on the differences in weights-at-length  (or weights at age). This assumes that the length measurements of the Unclassified category is "good."
  
The model selection metric I use should be related to that.  For example, "True" landings in each market category compared to "actual" landings in each market category, computed at the stockarea-year, stockarea-semester, or stockarea-year-semester level.  
--->    

We use CAMS data from 2015 to 2024 to train our data. The CAMS data complied by GARFO consists of dealer transactions matched to vessel trip reports. We briefly describe this datasource.  Dealer data are transaction-level entries of sales by federally permitted fish dealers, by market category, from each vessel to each dealer.   Vessel trip report data are subtrip-level reports of fishing activity by federally permitted vessels which include area fished, gear used, trip length, and estimates of quantity kept and discarded at the species level. In the Northeast United states, fishing vessels are required to file a logbook report for every combination of statistical area and subtrip. When vessels file more than one logbook per dealer sales transaction, we cannot definitively determine which which it belongs to.  That is, if a dealer record contains 500 pounds and a vessel fished in two statistical areas, CAMS allocates in proportion to the hail weights on those two trip reports.


Matching is performed based on the Vessel trip report serial number. When this match fails, matching is done based on the vessel permit number, dealer identifier, and date which are contained in both the vessel reports and the dealer reports. 

Black Sea Bass: sales by firms without a federal permit to dealers without a federal permit.  In some states, firms without a federal permit can fish for black sea bass in state waters and sell it to fish dealers who do not have a federal permit. These states require vessels to report their catch at a lower frequency and catch from these vessels is added into the dealer data at a higher.


The law of one price suggests two things. First, that the classification model should include variables explain prices in the classification model. These include attributes like gear used, whether the fish is sold live, state of landing, daily quantity landed, and time period of landing.  Without these variables, the classification model may interpret price as being informative of market category. For example, from Table \ref{HedonicTableA}, the average price of Medium Trawl- , Small Trawl-, and Small Gillnet- caught  black sea bass is \$3.75, \$3.52, and \$3.71 per pound, respectively. Excluding gear from the classification model would likely result in misclassification of some Small Gillnet caught fish as Medium fish.

Second, the law of one price suggests that if we cannot control for deviations from the law of one price for some observations, we should strongly consider removing them from the training dataset and not predicting class membership for those. We can think of three scenarios where this is likely to occur. First, there is less quality assurance and quality control for the species value field which we use to construct prices.  While there are checks to ensure that the values are within a reasonable range, firms that do not report accurately may not be required to improve their reporting accuracy. We handle this by excluding transactions with prices that are too high (over \$15 per pound) or too low (under \$0.15 per pound).  Second, buyers and sellers may be owned by the same entity, making definition of the  *ex-vessel* value somewhat vague.  Fully disentangling ownership is difficult, but inspection of the data suggested that some dealers-vessel pairs were exclusively transacting with each other, suggesting some vertical integration.  Firms may also participate in forward contracting in which the price of fish is determined well in advance.  To account  for the final two, we excluded transactions from dealer-year-market category combinations where the standard deviation of prices was less than 0.10.  Table Summary statistics describes charactieristics of the full dataset and the cleaned dataset.


<!---  
outcome variable: market_desc
id variables: dlrid,camsid 
case (frequency) weights: weighting (pounds sold)

There are 38 predictors:
price (nominal, I should try real)
gear
,stockarea
, state
, year
, month
, semester
, lndlb
, grade_desc

For observation i, daily Landings by other vessels in the same state , by market category  
StateOtherQJumbo
StateOtherQLarge
StateOtherQMedium
StateOtherQSmall

For observation i, daily Landings by other vessels from the same stockarea , by market category  

StockareaOtherQJumbo
StockareaOtherQLarge
StockareaOtherQMedium
StockareaOtherQSmall

For observation i, 7 day sum of landings by vessels from the same stockarea, by market category

MA7_StockareaQJumbo
MA7_StockareaQLarge
MA7_StockareaQMedium
MA7_StockareaQSmall

For observation i, 7 day sum of landings by vessels from the same state, by market category
MA7_StateQJumbo
MA7_StateQLarge
MA7_StateQMedium
MA7_StateQSmall
MA7_stockarea_trips
MA7_state_trips

could probably add a gearcategory variable.

Dealer share of purchases by market category from 2010-2014   
need to see if it's okay to leave in a less than full rank set of predictors. shares sum to 1. 

ShareJumbo, ShareLarge, ShareMedium,ShareSmall, ShareUnclassified 

Dealer total transactions by market category from 2010-2014   
TransactionCountJumbo, TransactionCountLarge, TransactionCountMedium,TransactionCountSmall, TransactionCountUnclassified
--->

Machine learning algorithms can often benefit from preprocessing of data. We have centered and scaled the continuous predictors so they have mean zero and a standard deviation of unity. More modeling choices are necessary. Missing values for predictors are handled by splitting the data as if they didn't exist, assigning the observations with missing values to each nodes, and selecting the node that has the decrease in impurity.   We treat factors variables as "unordered" and follow the implementation method described in @Hastie2009.  We grow 500 trees for each value of *mtry* when tuning the model; we do the same for training the final model. We stop splitting when there are five or fewer observations in a node.

```{r BSB_data, eval=F, echo=F}
source(here("writing","BSB.Classification.Recipe.R"))

```



# Results

Model tuning overview.

## Tuning results


```{r rocTune,echo=FALSE,out.width="70%",fig.show='hold', fig.align='center',fig.cap="ROC curve"}
knitr::include_graphics(here("results","ranger","tune", paste0("roc_tune_nocluster", pred_vintage, ".png")))
```

Our model fits well. In-sample ROC curves from tuning are quite similar across folds
and indicate that the tuned random forest does well at predicting market category  (Figure  \@ref(fig:rocTune))..

```{r vip,echo=FALSE,out.width="70%",fig.show='hold', fig.align='center',fig.cap="Variable Importance Plot"}
knitr::include_graphics(here("results","ranger","final", paste0("vipnocluster", pred_vintage, ".png")))
```

The VIP confirms that prices are very important in predicting market category (Figure  \@ref(fig:vip)).

```{r rocFinal,echo=FALSE,out.width="70%",fig.show='hold', fig.align='center',fig.cap="Variable Importance Plot"}
knitr::include_graphics(here("results","ranger","final", paste0("roc_nocluster", pred_vintage, ".png")))
```

The final ROC curve is similar to the individual tuning curves (Figure  \@ref(fig:rocFinal)), suggesting that the tuning stage did not 
overfit the model.



```{r validation_predictions, echo=FALSE, warning=FALSE}

# "confusion matrix" predictions, in pounds, by stockarea and market_category
testing_predictions<-nocluster_testing_predictions %>%
  group_by(stockarea,market_desc) %>%
    summarise(across(c(pred_Jumbo,pred_Large,pred_Medium,pred_Small), sum)) %>%
  ungroup()

# true landings by stockarea and market_category

true<-nocluster_testing_predictions %>%
  mutate(market_desc=as.character(market_desc))%>%
    group_by(stockarea,market_desc) %>%
    summarise(lndlb=sum(lndlb)) %>%
  ungroup()

# aggregate predictions, in pounds, by stockarea and market_category
p1<-nocluster_testing_predictions %>%
  group_by(stockarea) %>%
    summarise(across(c(pred_Jumbo,pred_Large,pred_Medium,pred_Small), sum)) %>%
  ungroup()

p2<-p1 %>%
  pivot_longer(cols=!stockarea, names_to="market_desc", names_prefix="pred_",values_to="predicted") 
  

mkt_preds<-p2 %>%
  left_join(true, by=join_by(stockarea==stockarea, market_desc==market_desc))
mkt_preds<-mkt_preds %>%
  mutate(predicted=predicted/lbs_per_mt,
         lndlb=lndlb/lbs_per_mt) %>%
  rename(true_mt=lndlb,
         predicted_mt=predicted,
         subregion=stockarea)%>%
  mutate(error=floor(100*(predicted_mt-true_mt)/true_mt))

mkt_preds$error=paste0(mkt_preds$error,"%")

knitr::kable(mkt_preds, caption='Predictions on the 10% Holdout Sample (mt).',format.args = list(big.mark = ","), digits=0, align=c("l",rep('r',times=4)))  
```

Table \@ref(tab:validation_predictions)), aggregates the individual predictions of the market category in the validation sample. I the South We find that the model slightly over-predicts YYY and underpredicts XXX.




#  Out of Sample Predictions


```{r nocluster_oos_predictions, echo=FALSE,warning=FALSE, fig.align='center'}
full_oos_predictions<-aggregate_oos_predictions %>%
  group_by(stockarea,year, market_desc) %>%
    summarise(across(c(pred_Jumbo,pred_Large,pred_Medium,pred_Small,lndlb), sum))%>%
   mutate(across(where(is.numeric), round, 0))%>%
  rename(true_pounds=lndlb) %>%
  ungroup()

  
p1<-full_oos_predictions %>%
  group_by(stockarea, year) %>%
    summarise(across(c(pred_Jumbo,pred_Large,pred_Medium,pred_Small), sum)) %>%
  ungroup()

mkt_preds<-p1 %>%
  pivot_longer(cols=starts_with("pred_"), names_to="market_desc", names_prefix="pred_",values_to="predicted") 
  
mkt_preds<-mkt_preds %>%
  mutate(year=as.numeric(as.character(year)),
         stockarea=as.character(stockarea)) %>%
  mutate(predicted_mt=predicted/lbs_per_mt)

mkt_preds<-mkt_preds %>%
  group_by(stockarea, market_desc) %>%
  arrange(stockarea, market_desc, year) %>%
  ungroup() %>%
    rename(subregion=stockarea)

 
ggplot(mkt_preds, aes(x=year, y=predicted_mt, group=market_desc))+
    geom_line() +
  scale_x_continuous(name="year", limits=c(2016,2024))  + 
  facet_grid(vars(subregion), vars(market_desc)) 

``` 



## Notes



<!---
\newpage
--->
# References
<div id="refs"></div>



\clearpage

# Appendix{-}

```{r child=here("writing","Appendix_Hedonic.Rmd"), eval=TRUE}
```

<!---
The boneyard:
The underlying data is taken from **STOCKEFF**, which originally used CFDBS and other sources. For more recent data, it points at "CAMS.CFDBS" style tables, which relies on CAMS.  It also does the area allocation also. It does some intermediate aggregation.  Then Emily pulls it from the stockeff webpage.  To bring anything to production probably will require pushing something to oracle.
--->


