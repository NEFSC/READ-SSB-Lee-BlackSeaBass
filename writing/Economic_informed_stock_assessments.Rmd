---
title: 'Economic Informed Stock Assessments: Using Prices to Understand the Length of Fish'
authors:
  - name: Min-Yang Lee
    email: Min-Yang.Lee@noaa.gov
    address: [NOAA Northeast Fisheries Science Center, 166 Water Street, Woods Hole, MA 02543, USA]
    corresponding_author: yes
  - name: Emily Liljestrand
    address: [NOAA Northeast Fisheries Science Center, 166 Water Street, Woods Hole, MA 02543, USA]
date: "`r format(Sys.time(), '%B %d, %Y')`" 
abstract: |
 The length- and age-structure of commercial landings is a crucial input to fish stock assessment. In the Northeast United States, NOAA Fisheries deploys samplers to fish dealers to measure the length of commercially landed fish.  When there are few or no samples of a market category of fish, the informational content of fish prices can be used to make an inference about the size of an unsampled market category. We use the Black Sea Bass fishery in the Northeast United States to illustrate our approach to using economic data to inform stock assessments.  There are 5 common market categories: Jumbo, Large, Medium, Small, and Unclassified.  From 2020 to 2023, 5 to 10% of commercial landings were in the “Unclassified” market category; but no fish in this category were measured. A preliminary hedonic model confirms that prices vary by market category: “Unclassified” Black Sea Bass are priced between “Large” and “Medium” fish. We fit a categorical Random Forest to predict the probability that a transaction belongs to a particular market category using prices and other variables.  We use the results to predict the probability of the “Unclassified” belonging to any of the other market categories, allowing us to construct a price-informed length structure of commercial landings. 
keywords: 
  - Hedonic Prices
  - Age structure
  -  Stock assessment
bibliography: "C:/Users/min-yang.lee/Documents/library.bib"
link-citations: yes
header-includes:
- \usepackage{graphicx}
- \usepackage{float}
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
output: 
  bookdown::pdf_book:
    base_format: rticles::oup_article
    keep_tex: yes
    toc: False
    fig_caption: yes
    pandoc_args: [ "--csl", "ices-journal-of-marine-science.csl" ]


---


 <!---- 
 The hardcoded bibilography is ghastly. 
Summary and Housekeeping

I did my data processing with  ``\stata_code\data_extraction_processing\extraction\commercial\00_cams_extraction.do`` and ``00_extraction_wrapper.do``

I also ran many of the  files in ``\stata_code\data_extraction_processing\analysis`` to do some exploratory analysis. 

Warnings: There is something funky going on with VA "status=PZERO" starting in 2021.  There is also something funky going on with Delaware landings, but there are no hullids/permit numbers so I don't think this will throw anything off at the vessel level.

--->

```{r global_options, include=FALSE}

library("foreign")
library("here")
library("tidyverse")
library("scales")
library("knitr")
library("lubridate")
library("kableExtra")
library("haven")
library("mapview")
library("sf")
library("htmltools")
here::i_am("writing/Economic_informed_stock_assessments.Rmd")
# pak::pak("adletaw/captioner")
library("captioner")
fig_nums <- captioner(prefix= "Figure")

#############################################################################
#knitr options
knitr::opts_chunk$set(echo = TRUE)

#knitr::opts_chunk$set(echo=FALSE, warning = FALSE, error = FALSE, message = FALSE, comment = FALSE, cache = FALSE, progress = TRUE, verbose = FALSE, 
#											dpi = 600)
options(tinytex.verbose = TRUE)
# options(knitr.table.format = "latex")
options(scipen=999)


#############################################################################
my_images<-here("images")

descriptive_images<-here("images","descriptive")
exploratory_images<-here("images","exploratory")


# Read in statistical areas
stat_areas_location<-here("data_folder","external","shapefiles","Statistical_Areas_2010.shp")
stat_areas <- st_read(dsn = stat_areas_location)

#trim out some stat areas that I don't care about.
stat_areas<-stat_areas %>%
  dplyr::filter(Id>=460) %>% # Canada
   dplyr::filter(Id<=711) %>% # SERO
  dplyr::filter(!Id %in% c(640,650,660,670,680) ) #Offshore

```

# Introduction

<!--- Include the next 2 child documents.   --->
```{r, child=here("writing", c("summary.Rmd")),  eval=FALSE}
```

The age-structure of commercial landings is a crucial input to the quantitative 
stock assessments in the Northeast United States. In the Northeast US, commercial
fishing vessels catch fish and sell their landed fish to fish dealers, who sort
the catch into market categories.   The National Marine Fisheries Service
deploys biological samplers to measure the length of commercially landed fish. 
Otoliths are collected from a subset of measured fish; this information is used
to convert the landed weight of all market categories into a vector of numbers-at-age
of commercial landings. 

The stock assessment enterprise in the Northeast U.S. has a series of business 
rules for handling gaps in the market category to age relationship that arise 
when certain market categories are either not sampled or under sampled. This 
typically involves borrowing from neighboring strata.

In this article, we propose an alternative approach that involves using the 
information contained in fish prices to fill in information about the size of
these unmeasured fish. The Black Sea Bass fishery in the Northeast United States
is to illustrate our approach to using economic data to inform stock assessments.
There are 5 common market categories: Jumbo, Large, Medium, Small, and 
Unclassified.  From 2020 to 2023, 5 to 10% of commercial landings were in the 
“Unclassified” market category; however no fish in this category were measured. 

General approach. Verify this will work by estimating a not-too-complicated hedonic
model.  Look at the coefficients on sizes. Train a random forest model to classify
using data containing four classes. Predict out of sample on data that is Unclassified.

Our ultimate goal is to improve the stock assessment enterprise through a better
estimate of the true size of the un-measured "Unclassified" fish. This requires 
predictions of the Unclassified fish to be aggregated to the year-stock unit level. The accuracy of
an individual prediction is of limited interest. Therefore, we adapt the model training step and use training measures that are closely 
tied to this.  We predict the probabilities of class membership, that is "Small", 
"Medium", "Large", or "Jumbo", for the un-measures "Unclassified" 
fish.  We then use the length- and age-data for those market categories to make 
a prediction about the Unclassified fish. 

This method is good because it can be applied to existing streams of historical data.
It can also be used to allocated sampling coverage.

# Background

<!--- Include the next 2 child documents.   --->
```{r, child=here("writing", c("BSB_history.Rmd", "BSB_economic_background.Rmd")),  eval=FALSE}
```

## Catching, Selling, and Classifying Fish

Black sea bass are caught by fishing vessels that typically use bottom trawl and
pot/trap gear; gillnets and lines are less commonly used. Firms can target both
sizes of fish and their catch of other species, but cannot perfectly control 
what they catch and land.  For example, the seasonal inshore movement during 
the spring and offshore movement affects things.  When fish offshore, they are
less available to smaller vessels or those that are registered in states that 
manage with stringent possession limits.  Strong year classes can make a size 
class more available during certain years.   

After landing, fish are delivered to buyers (fish dealer), where they classified into market categories by the *dealer*.  There are four prevalent market categories (Jumbo, Large, Medium/Market, and Small), plus an "Unclassified" category^[There is a "Mixed or Unsized" market category (combined with the "Unclassified" market category). The Extra Small and PeeWee are combined with the Small category.]  Fish in the "Unclassified" or "Mixed" category are precisely that, an unobserved combination of the other market categories. The definitions of the size classes may vary over time (year-to-year, month-to-month) or space (state-to-state or stock area to stock area).  Fish dealers may act as middlemen, simply selling fish to processors, restaurants, or final consumers.  They may do some processing themselves and sell filleted fish to entities farther along the value chain.

Prices of fish depend on the size of fish; the fact consumers typically prefer larger fish both motivates and necessitates the collection of size information by disaggregated by market category.  Prices are also influenced by other attributes, including freshness, fat content, water content,buyer- and seller- effects, and the quantity attributes supplied to the market^[@McConnell2000, @Carroll2001, @Kristofersson2004, @Kristofersson2007,  @Hammarlund2015,  @Gobillon2017, and @Ardini2018 are just a few examples.] 

Using prices to predict market category would only be possible if prices did vary by market category. A simple hedonic model confirms that they do.  The price of Jumbo Black Sea Bass is approximately \$6 per pound, while the price of small Black Sea Bass is closer to \$3.50 (Table \ref{HedonicTableA}).  Interestingly, the Unclassified market category has an average price of \$4.40 per pound, in between that of Large and Medium fish, suggesting that Unclassified fish may be a mix of these other two categories. ^[A hedonic price model is not the main focus of this research, nevertheless, we report more details about the simple model in the Appendix.] 

\input{../results/hedonic_tableA.tex}

## Regulatory Environment

The fishery is jointly managed by the ASFMC and the MAFMC.  Regulations are enacted 
by GARFO.  There is also a South Atlantic stock that is managed by SAFMC.

From 1996 through 2003, the fishery was managed primarily by quarterly catch 
limits for the entire fishery. There were early closures in 1999 (Quarters 2,3,4),
2000 (2,3,4), and 2001 (all). Quota was allocated to each state staring in 2003
(Amendment 13) and is monitored based on landed state. In 2021, the formula 
that allocates commercial quotas to the states was revised; 75% of the quota is
allocated according to historical  fishing and 25% is allocated in proportion 
to where the biomass is located.

There is some catch that occurs within state waters by fishing vessels that do not 
have federal permits, so the Vessel
Trip Report (logbook) coverage isn't perfect. Three states  (MD, DE, and VA) 
have IFQ programs that started in 2004. Current minimum size limits are 11" 
or 12".  Possession limits vary widely by state; the IFQ states do not have 
possession limits while Massachusetts and Rhode Island use seasonally varying 
limits that have been as strict as 50 lbs/day or as loose as 1,500 lbs per week.
Nearly all states require a vessel operator to have a limited access permit to 
land black sea bass in that state.

## Black Sea Bass and the Stock Assessment Enterprise 
Analysts request coverage levels of different market categories. 

Need to justify having these as explanatory variables (predictors). 

    * Stock area (north and south): The stocks are different and have different
    underlying size compositions. For example, there appears to be a sizable 2012
    year class in the North stock that persists to age 6 in 2017.  There's few 
    age 4+ in the south. This is from the 2024 BSB unit pdf.
    * Semester
    * Recent landings in the stock area by market category: catching fish is patchy.
    If vessels are catching alot of larges, they are going to keep catching lots of 
    larges.
    * recent landings in the state by market category: Same. In addition, there's 
    persistent "demand" if vessels can move around. processors and customers
    are set up for certain things.
    * today's landings from a stock area by market category by other boats: same as above
    * today's landings from a in a state by market category by other boats
    * state and stock area trips
    * lndlb (trip level landings by market category)
    * trip level landings of black sea bass -- trips with large quantities might
    be more likely to sort, 


```{r borrowed_lengths,echo=FALSE,out.width="48%", fig.align='center'}
knitr::include_graphics(here("images","background",c("2023_BSB_UNIT_TOR2_commercialdata_slide8.jpg")))
```

`r fig_nums(name="Borrowed_lengths", caption ="Borrowed Lengths in Black Sea Bass.")`

Slide 8 from ``2023_BSB_UNIT_ppt_TOR2_commercialdata.pdf`` (`r fig_nums("Borrowed_lengths", display="cite")`) illustrates the problem generally.  Pink in the bar graphs are good, this means there were enough measured fish in a market category.  Everything else indicates a certain amount of "borrowing" of data, where lengths are taken from market-area-semester combination.  


# Methods and Data

The core of this research question is accurate prediction of the market category, not understanding the causal mechanisms by which one variable affects another.  Machine learning, which focuses on $\hat{y}$ instead of $\hat{\beta}$ is likely to be a good approach [@Varian2014, @Mullainathan2017].  Economic theory and on-the-ground expertise of the subject matter (the black sea bass fishery) helps guide variable selection [@Mullainathan2017].  We first provide a general description of the machine learning method, before describing and justifying the methods, modeling choices, and data that we use in this application.

Many machine learning models have been developed to perform multinomial classification.  The following description draws heavily on [@Strobl2009, @Varian2014, @Mullainathan2017, and @Hastie2023].  Classification and Regression Trees [CART, @Breiman1984] and their evolutionary offshoots are attractive methods for multinomial classification.  A classification tree performs recursive binary splitting.  The dependent variable is partitioned into two groups based on a single explanatory variable.  The optimal explanatory variable to use (and, for continuous explanatory variables, the value at which the split occurs) is based on minimizing a measure of variation among member of the partition.  A good split will results in a large reduction in the variation among the observations in the partition.  The CART algorithm continues splitting until a user specified stopping-criteria is met. It is top-down, because it begins operation on the whole dataset and it is "greedy" or "naive" because it does not look ahead. 

Classification trees are quite unstable and therefore can be prone to poor out of sample performance.  Bagging is a way to improve performance. Bagged classification trees simply bootstrap the classification tree and then aggregate in a reasonable way. Random forests are another improvement.  Random forests are bagged classification trees that also have a restricted the number of predictors. This increases the variation in the trees and can improve out of sample performance.  The number of predictors to include in the model is a hyperparameter and the optimal value of this hyperparamter is determined during the model training process.

Training
  - Tuning hyper parameters
  - Training - after finding the best hyper parameters, fitting a final model
  - Validation -- out of sample prediction


Machine learning in fisheries has become increasingly popular [@Malde2020]; the themed section ``Applications of machine learning and artifical intelligence in marine science`` contains many papers, most of which are application of image proceesing algorithms.  @Alvarez-Ellacuria2020 collection of length data is a different way to address a similar problem; how large are the fish that are caught? In fisheries, random forests have also been used to classify acoustic data [@Fallon2016, @Proud2020]; fishery metiers [@Oostdijk2024], and habitat [@Liu2025].

## Our approach

We use data from 2015 to 2024 to train our data. We set aside 20% of our
data as a hold out sample to validate model fit.  Dealers are the entities that
classify the fish and dealers are likely to have an unobserved propensity to 
grade fish into particular classes. This unobserved heterogeneity poses two challenges.  

First, including a full set of binary indicator variables to account dealer-specific 
effects ("one-hot" encoding) can lead to both overfitting
[@Breiman2001; @Hastie2023] and bias [c.f @Strobl2007; @Strobl2009]. 
Instead we use a variation of target encoding.  Application of a standard
target-encoding system would involve computing dealer-specific class probabilities
over the 2015-2025 and including those probabilities as factors. This feels 
somewhat troubling to an economist concerned about simultaneity, a concern which
may be misplaced. Nevertheless, we compute dealer-specific class probabilities
over the **2010-2014** time period and enter these as predictors instead. Dealers 
that did not buy or sell black sea bass during this time have missing values.

Second, @Roberts2017 note that standard cross-validation techniques can be overly optimistic
when observations are dependent but are implicitly treated as independent during a random cross-validation.   This occurs because 
the hold out data used for cross-validation is not actually independent. @Roberts2017 suggest
that the practical implications of this depend on the purposes of the model; if prediction on 
"similar" data is the goal, then a standard cross-validation may be appropriate.
We try two methods of cross validation in our training.  The first is the standard random cross-validation; observations are assigned randomly into folds.  In the second method, we group by "dealer identifier" so that all of a dealer's observations are contained
in either the training dataset or the validation dataset.  This ensures that the
validation fold does not inadvertently contain "training data", which would lead
to overly optimistic model fit.  Keeping the entirety of dealer's
observations in either the training or validation datasets reduces the likelihood
of information leakage^[Information leakage occurs when the ml model essentially 
memorizes the input data, leading to validation metrics that are overly-optimistic.  
This can cause poor out of sample predictions.]


We divide the remaining 80\% of the data into 10 approximately equal folds, again
keeping all observations from a dealer in exactly one fold.  We use the 10-fold
cross validation to select the optimal *mtry* parameter for the random forest. 
We use the Briar classification score to tune the mtry hyperparameter [@Kruppa2014].  After tuning, we train 
the model on the entire 80% training sample and validate
on the remaining 20\%. This provides some assurance that the model has good 
out-of-sample prediction. Finally, we train the model on the entire dataset to 
use in out-of-sample prediction.  


<!---  

need to blend in the data to make this a little easier to follow.
--->

<!---  

  A second, less-conventional validation might be available.  We have some years (2018-2020) where we sample lengths for the unclassified fish.  This can be used to construct a true catch-at-length distribution (outside the ML model). Inside the ML model, we predict the class of the "unclassified" into the constituent market categories and apply the length keys to those to form a catch-at-length distribution.  Construct some sort of loss function based on the differences in weights-at-length  (or weights at age). This assumes that the length measurements of the Unclassified category is "good."
  
  The model selection metric I use should be related to that.  For example, "True" landings in each market category compared to "actual" landings in each market category, computed at the stockarea-year, stockarea-semester, or stockarea-year-semester level.  
--->    


## Data

Matched dealer and vessel trip report data from 1996-2024 is available.  Vessel trip report data are trip-level reports of fishing activity by federally permitted vessels which include area fished, gear used, trip length, and estimates of quantity kept and discarded at the species level. Dealer data are transaction-level entries of sales by federally permitted fish dealers, by market category, from each vessel to each dealer. Matching is performed based on the Vessel trip report serial number. When this match fails, matching is done based on the vessel permit number, dealer identifier, and date which are contained in both the vessel reports and the dealer reports.

  - VTRs are sub-trip.
  _ We cannot match the dealer landings to a subtrip, so if a vessel fished in multiple statistical areas or used multiple gears, it's we have some measurement error here.

There are two empirical challenges.  First, what to do with these "multi-subtrip" transactions that do not match? Second, what to do with aggregates? 

Black Sea Bass: sales by firms without a federal permit to dealers without a federal permit.  In some states, firms without a federal permit can fish for black sea bass in state waters and sell it to fish dealers who do not have a federal permit. These states require vessels to report their catch at a lower frequency and catch from these vessels is added into the dealer data at a higher.

outcome variable: market_desc
id variables: dlrid,camsid 
case (frequency) weights: weighting (pounds sold)

There are 38 predictors:
price (nominal, I should try real)
gear
,stockarea
, state
, year
, month
, semester
, lndlb
, grade_desc

For observation i, daily Landings by other vessels in the same state , by market category  
StateOtherQJumbo
StateOtherQLarge
StateOtherQMedium
StateOtherQSmall

For observation i, daily Landings by other vessels from the same stockarea , by market category  

StockareaOtherQJumbo
StockareaOtherQLarge
StockareaOtherQMedium
StockareaOtherQSmall

For observation i, 7 day sum of landings by vessels from the same stockarea, by market category

MA7_StockareaQJumbo
MA7_StockareaQLarge
MA7_StockareaQMedium
MA7_StockareaQSmall

For observation i, 7 day sum of landings by vessels from the same state, by market category
MA7_StateQJumbo
MA7_StateQLarge
MA7_StateQMedium
MA7_StateQSmall
MA7_stockarea_trips
MA7_state_trips

could probably add a gearcategory variable.

Dealer share of purchases by market category from 2010-2014   
need to see if it's okay to leave in a less than full rank set of predictors. shares sum to 1. 

ShareJumbo, ShareLarge, ShareMedium,ShareSmall, ShareUnclassified 

Dealer total transactions by market category from 2010-2014   
TransactionCountJumbo, TransactionCountLarge, TransactionCountMedium,TransactionCountSmall, TransactionCountUnclassified




## Random Forest 

Random Forest  CART. RF. Applications in fisheries and economics?

```{r BSB_data, eval=F, echo=F}
source(here("writing","BSB.Classification.Recipe.R"))

```



# Results


```{r child=here("results","mnl_logit.Rmd"), eval=FALSE}
```



# Machine Learning Results

## Goodness of Fit

## Notes



<!---
\newpage
--->
# References
<div id="refs"></div>



\clearpage

# Appendix{-}

```{r child=here("writing","Appendix_Hedonic.Rmd"), eval=TRUE}
```

<!---
The boneyard:
The underlying data is taken from **STOCKEFF**, which originally used CFDBS and other sources. For more recent data, it points at "CAMS.CFDBS" style tables, which relies on CAMS.  It also does the area allocation also. It does some intermediate aggregation.  Then Emily pulls it from the stockeff webpage.  To bring anything to production probably will require pushing something to oracle.
--->


